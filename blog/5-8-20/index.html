<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.56">
<title data-react-helmet="true">Istio Control Plane Upgrades using Canary Deployments | Raspbernetes</title><meta data-react-helmet="true" property="og:title" content="Istio Control Plane Upgrades using Canary Deployments | Raspbernetes"><meta data-react-helmet="true" name="description" content="Co-author: Omar Steitieh"><meta data-react-helmet="true" property="og:description" content="Co-author: Omar Steitieh"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.5957e751.css">
<link rel="preload" href="/styles.efbe3c85.js" as="script">
<link rel="preload" href="/runtime~main.4253185a.js" as="script">
<link rel="preload" href="/main.de31149c.js" as="script">
<link rel="preload" href="/1.6ef5ccd2.js" as="script">
<link rel="preload" href="/2.aad52cc2.js" as="script">
<link rel="preload" href="/3.a8e9dd53.js" as="script">
<link rel="preload" href="/ccc49370.88ac8ec2.js" as="script">
<link rel="preload" href="/ed758c06.a7f977e1.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="Raspbernetes Logo"><strong class="navbar__title">Raspbernetes</strong></a><a class="navbar__item navbar__link" href="/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/raspbernetes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="Raspbernetes Logo"><strong class="navbar__title">Raspbernetes</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">Docs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/raspbernetes" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--8 col--offset-2"><article><header><h1 class="margin-bottom--sm blogPostTitle_2RZH">Istio Control Plane Upgrades using Canary Deployments</h1><div class="margin-vert--md"><time datetime="2020-12-30T01:59:05.508Z" class="blogPostDate_3tRe">December 30, 2020  · 4 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/xUnholy" target="_blank" rel="noreferrer noopener"><img src="https://avatars3.githubusercontent.com/u/20387402?s=400&amp;u=fbb33b14f7f7328a98ea87dc162a334c9bc97523&amp;v=4" alt="Michael Fornaro"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/xUnholy" target="_blank" rel="noreferrer noopener">Michael Fornaro</a></h4><small class="avatar__subtitle">Senior DevOps Engineer</small></div></div></header><section class="markdown"><p>Co-author: Omar Steitieh</p><p><img src="https://github.com/raspbernetes/raspbernetes.github.io/raw/master/img/istio-blog-banner.jpg" alt="Istio Blog Banner" title="Istio Blog Banner"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="overview"></a>Overview<a aria-hidden="true" tabindex="-1" class="hash-link" href="#overview" title="Direct link to heading">#</a></h2><p>A new feature to support canary deployments of the Control Plane was included in Istio version 1.5.x. This blog aims to demonstrate this feature, The steps below assume you have version 1.6+ installed and running in your cluster.</p><p>An introduction to deployment strategies; blue-green, canary and more can be found <a href="https://dev.to/mostlyjason/intro-to-deployment-strategies-blue-green-canary-and-more-3a3" target="_blank" rel="noopener noreferrer">here</a></p><p>Istio service mesh has two main components; Control Plane &amp; Data Plane</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="control-plane"></a>Control Plane<a aria-hidden="true" tabindex="-1" class="hash-link" href="#control-plane" title="Direct link to heading">#</a></h3><p>The Control Plane is responsible for service discovery, routing configuration, providing service-to-service, and end-user authentication. It also allows secure mTLS communication in the data plane by maintaining a CA and generating certificates. Since 1.5.x, the control plane components have been consolidated into a single service called istiod.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="data-plane"></a>Data Plane<a aria-hidden="true" tabindex="-1" class="hash-link" href="#data-plane" title="Direct link to heading">#</a></h3><p>The Data Plane consists of Envoy proxies deployed as sidecars to every Istio enabled pod in the cluster. They intercept any incoming or outgoing requests from the main container in the pod for two purposes; firstly they provide encryption, controlling the communication between pods and secondly they provide telemetry on all network traffic.</p><p>We will deploy a second Istio control plane which will be used to canary traffic in a namespace.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="getting-started"></a>Getting Started<a aria-hidden="true" tabindex="-1" class="hash-link" href="#getting-started" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="control-plane-1"></a>Control Plane<a aria-hidden="true" tabindex="-1" class="hash-link" href="#control-plane-1" title="Direct link to heading">#</a></h3><p>You currently have an existing Istio control plane running. To deploy a canary control plane you must set the revision field. This can be done either using the istioctl CLI tool installation method or via using the istio-operator.</p><p>istioctl example:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-bash codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">istioctl </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> --set </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">revision</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">canary</span></div></div></div></div></div><p>When installing Istio using istioctl the default profile will be applied automatically unless otherwise specified, to use a custom profile our preferred method is to deploy using the IstioOperator resource. Pre-configured profiles can be viewed <a href="https://istio.io/latest/docs/setup/additional-setup/config-profiles/" target="_blank" rel="noopener noreferrer">here</a>.</p><p>istio-operator example:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> install.istio.io/v1alpha1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> IstioOperator</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">canary</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">system</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">revision</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> canary</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span></div></div></div></div></div><p>Note: IstioOperator available options can be viewed <a href="https://istio.io/latest/docs/reference/config/istio.operator.v1alpha1/" target="_blank" rel="noopener noreferrer">here</a></p><p>Once applied a second control plane will be created. Both the existing and the canary revision will be running in the cluster.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-bash codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">NAME                           READY   STATUS    RESTARTS  AGE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">istiod-7f7d5496cf-ltff2         </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">/1    Running   </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">        5m45s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">istiod-canary-7f7d5496cf-ltff2  </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">/1    Running   </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">          15s</span></div></div></div></div></div><p>When the canary istiod pod is running it’s worth mentioning that both the <code>ingress</code> and <code>egress</code> gateway pods will upgrade to the new version and old pods will be terminated — this was surprising as now all the data plane proxies within the cluster do not have version parity. Consequently, it is <strong>highly</strong> recommended to check changelogs between versions!</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="data-plane-1"></a>Data Plane<a aria-hidden="true" tabindex="-1" class="hash-link" href="#data-plane-1" title="Direct link to heading">#</a></h3><p>Creating a canary control plane has no impact on the data plane. To roll out your sidecar <code>istio-proxy</code> updates to the new version of the control plane take the following steps.</p><p align="center"><img src="https://github.com/raspbernetes/raspbernetes.github.io/raw/master/img/istio-canary-1.png" alt="Istio Canary 1"></p><p>Remove the existing namespace label <code>istio-injection</code> and add a new label <code>istio.io/rev=canary</code>.</p><p>This can be done with the following command:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-bash codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl label namespace </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">namespace</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> istio-injection- istio.io/rev</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">canary</span></div></div></div></div></div><p><em>Note: The <code>istio-injection</code> label must be removed because it takes precedence over the <code>istio.io/rev</code> label for backward compatibility.</em></p><p>After the namespace labels have been updated you will need to restart the pods to trigger re-injection:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-bash codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl rollout restart deployment -n </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">namespace</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span></div></div></div></div></div><p>Once the pods have been recreated they will be configured to point to the new canary Istio control plane.</p><p align="center"><img src="https://github.com/raspbernetes/raspbernetes.github.io/raw/master/img/istio-canary-2.png" alt="Istio Canary 2"></p><p>Confirm the pods are now using the canary revision of the Istio control plane by running this command against one of the restarted pods:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-bash codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">istioctl proxy-config endpoints </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">pod</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">.</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">namespace</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> --cluster xds-grpc -ojson </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">hostname</span></div></div></div></div></div><p>Expected output:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-bash codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">“hostname”: “istiod-canary.istio-system.svc”</span></div></div></div></div></div><p align="center"><img src="https://github.com/raspbernetes/raspbernetes.github.io/raw/master/img/istio-canary-3.png" alt="Istio Canary 3"></p><p>After successfully testing the new control plane version continue to roll out the upgrade to the remainder of the cluster workloads using the same approach.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="summary"></a>Summary<a aria-hidden="true" tabindex="-1" class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>Points to consider when choosing to use Istio canary releases using revisions:</p><p><strong>Promoting the canary release</strong> — We recommend using the version as the revision. This keeps each namespace with an explicit label of the control plane version being used.</p><p><strong>Potential downtime</strong> — Consideration for the ingress and egress gateways must be taken into account. Possible version disparity between istio-proxy sidecars could introduce breaking changes that impact proxy traffic and would require a re-deployment of the previous control plane.</p><p><strong>Validating revision before adoption</strong> — Restarting all pods in a namespace may cause a large impact if something goes wrong. Consider scaling the deployments instead to test new pods communicating to the new control plane revision.</p><p><em>Note: Everything in this article was tested using Istio 1.6.5 running on our Raspberry Pi Kubernetes cluster built using the <a href="https://github.com/raspbernetes" target="_blank" rel="noopener noreferrer">Raspbernetes project</a>.</em></p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/kubernetes">kubernetes</a><a class="margin-horiz--sm" href="/blog/tags/raspberry-pi">raspberry pi</a><a class="margin-horiz--sm" href="/blog/tags/raspbernetes">raspbernetes</a><a class="margin-horiz--sm" href="/blog/tags/istio">istio</a><a class="margin-horiz--sm" href="/blog/tags/canary">canary</a></div></footer></article><div><a href="https://github.com/raspbernetes/docs/edit/master/website/blog/blog/5-8-20.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/16-7-20"><div class="pagination-nav__sublabel">Previous Post</div><div class="pagination-nav__label">« Automated HA Kubernetes deployment on Raspberry Pis</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Guides</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/Raspbernetes" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/Raspbernetes" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/Raspbernetes" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/raspbernetes" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright © 2020 Raspbernetes, Inc. Built with ❤️</div></div></div></footer></div>
<script src="/styles.efbe3c85.js"></script>
<script src="/runtime~main.4253185a.js"></script>
<script src="/main.de31149c.js"></script>
<script src="/1.6ef5ccd2.js"></script>
<script src="/2.aad52cc2.js"></script>
<script src="/3.a8e9dd53.js"></script>
<script src="/ccc49370.88ac8ec2.js"></script>
<script src="/ed758c06.a7f977e1.js"></script>
</body>
</html>